jQuery(document).ready((function(e){"use strict";function t(t){return e('<span><i class="fa fa-'+t.text+'"></i>   '+t.text+"</span>")}function i(i){void 0!==e.fn.select2&&e.each(i,(function(){let i,n;e(this).hasClass("icon-select")?(n=e(this).data("value"),i={data:ywcmap_icons,templateResult:t,templateSelection:t}):i={minimumResultsForSearch:10},e(this).select2(i),void 0!==n&&n&&e(this).val(n).change()}))}i(e("#yith_wcmap_panel_general").find("select")),i(e("#yith_wcmap_banners").find("select")),e(document).on("yith-add-box-button-toggle",(function(){i(e("#yith_wcmap_banners_add_box").find("select"))})),e(document).on("yith_select_images_value_changed",(function(t){let i=e('select[name="yith_wcmap_menu_position"]').val(),n=e("#yith_wcmap_menu_layout-wrapper li");"horizontal"!==i&&(i="vertical"),e.each(n,(function(t){e(this).find("img").attr("src",e(this).attr("data-"+i))}))})).trigger("yith_select_images_value_changed");const n={itemsSection:e("#yith-wcmap-items-list"),addItemForm:e("#yith-wcmap-add-item-form"),itemsForm:e("#yith-wcmap-items-form"),itemsList:e(".items-container"),init:function(){if(!this.itemsForm.length)return!1;this._nestable(),this._handleOptionsDeps(),i(this.itemsForm.find("select")),e(document).on("yith_wcmap_item_added",this._reInitItem),this.itemsList.on("click",".toggle-options",this.toggleOptions),this.itemsList.on("change",".item-actions .on_off",this.onOffItem),this.itemsList.on("click",".remove-item",this.removeItem),this.itemsList.on("click",".save-item",this.saveItem),this.itemsList.on("change",this._reInitItem),this.itemsSection.on("click",".create-new-item",this.createNewItem),this.addItemForm.on("submit",this.addItem),this.itemsSection.on("click",".insert-banner-button",this.bannersModal),this.itemsSection.on("keyup",".required-error",this._resetRequiredError),this.itemsForm.on("submit",this.submitForm)},_nestable:function(){void 0!==e.fn.nestable&&this.itemsList.nestable({expandBtnHTML:"",collapseBtnHTML:""})},_handleOptionsDeps:function(){n.itemsSection.find("[data-deps]:not(.deps-initialized)").each((function(){let t=e(this),i=t.attr("data-deps").split(","),n=t.attr("data-deps_value").split(","),a=[];t.addClass("deps-initialized"),e.each(i,(function(i,s){e('[name="'+s+'"]').on("change",(function(){let s=this.value,o="";("radio"!=this.type||e(this).is(":checked"))&&("checkbox"==this.type&&(s=e(this).is(":checked")?"yes":"no"),o=n[i]+"",o=o.split("|"),a[i]=-1!==e.inArray(s,o),-1===e.inArray(!1,a)?t.fadeIn():t.hide())})).change()}))}))},_reInitItem:function(e,t){void 0!==t&&(i(t.find("select")),n._handleOptionsDeps(),n._initTinyMCE(t.find("textarea").attr("id")))},_addItemToList:function(t,i){let a=n.itemsList.find('li[data-id="'+t+'"]');a.length?a.replaceWith(i).fadeIn():n.itemsList.children("ol").append(i),i=n.itemsList.find('li[data-id="'+t+'"]'),e(".dd").nestable("reset"),e(document).trigger("yith_wcmap_item_added",[i])},_ajaxRequest:function(t,i){return t.push({name:"action",value:ywcmap.ajaxAction},{name:"security",value:ywcmap.ajaxNonce},{name:"context",value:"admin"},{name:"page",value:ywcmap.page}),e.ajax({url:ywcmap.ajaxUrl,data:t,dataType:"json",type:"POST",beforeSend:function(){i.find(".spinner").addClass("show"),i.block({message:null,overlayCSS:{background:"#fff no-repeat center",opacity:.5,cursor:"none"}})},complete:function(){i.find(".spinner").removeClass("show"),i.unblock()}})},_initTinyMCE:function(e){let t=tinyMCEPreInit.mceInit,i=Object.keys(t)[0],n=t[i],a=tinyMCEPreInit.qtInit,s=t[Object.keys(a)[0]];n.selector=e,n.body_class=n.body_class.replace(i,e),s.id=e,tinyMCE.init(n),tinyMCE.execCommand("mceRemoveEditor",!0,e),tinyMCE.execCommand("mceAddEditor",!0,e),quicktags(s),QTags._buttonsInit()},_validateRequired:function(t,i){let n=[],a=0;return e.each(t,(function(e,t){let s=i.find('[name="'+t.name+'"]');s.hasClass("required")&&""===t.value&&(s.addClass("required-error"),n[a++]=s)})),!n.length||(window.scrollTo({top:n[0].offset().top-200,left:0,behavior:"smooth"}),!1)},_resetRequiredError:function(t){e(this).val()&&e(this).removeClass("required-error")},toggleOptions:function(t){e(this).closest(".item").toggleClass("opened").find(".item-content").first().toggleClass("dd-nodrag").end().find(".item-options").first().slideToggle()},onOffRestore:function(e){e.is(":checked")?e.removeAttr("checked").removeClass("onoffchecked"):e.prop("checked",!0)},onOffItem:function(t){t.preventDefault();let i=e(this).closest(".item"),a=[{name:"request",value:"activate"},{name:"value",value:e(this).is(":checked")?"yes":"no"},{name:"item",value:i.data("id")}];n._ajaxRequest(a,i).done((t=>{t?.success||n.onOffRestore(e(this))})).fail((t=>{console.log(t),n.onOffRestore(e(this))}))},removeItem:function(){if(!0!==confirm(ywcmap.removeAlert))return!1;{let t=e(this).closest(".item"),i=[{name:"request",value:"remove"},{name:"item",value:t.data("id")}];n._ajaxRequest(i,t).done((e=>{if(e?.success){let e=t.find("ol.items");if(e.length){let i=e.find("li.item");t.after(i)}t.remove()}})).fail((e=>{console.log(e)}))}},saveItem:function(t){t.preventDefault();let i,a=e(this).closest(".item"),s=a.data("id");if(e(".wp-editor-tabs").find("button.switch-html").click(),i=n.itemsForm.serializeArray().filter((function(e){return e.name.replace(/(\[.*\])/,"")==="yith_wcmap_endpoint_"+s})),!i.length||!n._validateRequired(i,a))return!1;i.push({name:"request",value:"save"},{name:"item",value:s},{name:"type",value:a.data("type")}),n._ajaxRequest(i,a).done((e=>{e?.success&&n._addItemToList(e.data.id,e.data.html)})).fail((e=>{console.log(e)}))},submitForm:function(){if(void 0!==e.fn.nestable){var t=e(".dd").nestable("serialize"),i=JSON.stringify(t);e("input.items-order").val(i)}},createNewItem:function(t){t.stopPropagation();let i=e(this).text(),a=e(this).data("target"),s=wp.template("new-"+a+"-item");if(e(this).siblings().hasClass("closed"))return!1;if(e(this).hasClass("closed"))e(this).text(e(this).data("label")).data("label",i).removeClass("closed").siblings("button").show(),n.addItemForm.hide().find(".new-item-template").remove(),n.addItemForm.find('input[name="type"]').val("");else{e(this).text(e(this).data("label")).data("label",i).addClass("closed").siblings("button").hide(),n.addItemForm.prepend(s({})).fadeIn(),n.addItemForm.find('input[name="type"]').val(a);let t=n.addItemForm.find(".new-item-template");e(document).trigger("yith_wcmap_item_added",[t])}},addItem:function(t){let i;if(t.preventDefault(),i=n.addItemForm.serializeArray(),!n._validateRequired(i,e(this)))return!1;i.push({name:"request",value:"add"}),n._ajaxRequest(i,e(this)).done((t=>{t?.success&&(e(".create-new-item.closed").click(),n._addItemToList(t.data.id,t.data.html))})).fail((e=>{console.log(e)}))},bannersModal:function(t){t.preventDefault();let n=e(this).data("editor"),a=e("#banners-modal");a.length&&void 0!==e.fn.dialog&&a.dialog({resizable:!1,modal:!0,dialogClass:"yith-wcmap-banners-modal yith-plugin-ui",buttons:{Add:function(){let t=e(this).find(".banners").val();if(t.length&&"undefined"!=typeof tinymce){let i=e("#"+n),a=tinymce.get(""+n),s=ywcmap.bannerShortcode.replace("{{banners}}",t.join(","));null!=typeof a&&a.execCommand("mceInsertContent",!1,s),i.val(i.val()+s).change()}a.dialog("close")}},open:function(t,n){i(e(this).find("select"))},close:function(t,i){e(this).find(".banners").val(""),a.dialog("destroy")}})}};n.init()}));